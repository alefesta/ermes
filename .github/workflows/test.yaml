name: Tensorboard
on:
  issue_comment:
    types:
      - created
      - edited

jobs:

  Tensorboard-Stop:
    if: ${{ github.event.comment.body == '/done'}}
    concurrency: 
      group: ${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Shutdown
        run: exit 0
  
  Tensorboard-Start:
    concurrency: 
      group: ${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    if: ${{ github.event.comment.body == '%tensorboard'}}
    steps:
      - name: Set-Up-Environment
        run: |
          pip install --upgrade pip tensorboard
          tensorboard --logdir /tmp --port 6006 &
      - run: wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        shell: bash
      - run: unzip -qq ngrok-stable-linux-amd64.zip
        shell: bash
      - run: ./ngrok authtoken ${{ secrets.NGROK_SECRET }}
        shell: bash
      - id: url
        run: |
          ./ngrok http -log=stdout 6006 > /dev/null &
          sudo curl -s http://localhost:4040/api/tunnels/command_line | sudo jq -r --unbuffered '.public_url'
          sleep infinity
        shell: bash
      - name: 📝 Tensorboard URL
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            You may use Tensorboard at: [](${{steps.url.outputs.body}})
  


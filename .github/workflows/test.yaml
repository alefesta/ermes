name: Tensorboard
on:
  issue_comment:
    types:
      - created

jobs:
  Tensorboard-Start:
    runs-on: ubuntu-latest
    if: ${{ github.event.comment.body == '%tensorboard'}}
    steps:
      - name: Set-Up-Environment
        run: |
          pip install --upgrade pip tensorboard
          tensorboard --logdir /tmp --port 6006 &
      - run: wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        shell: bash
      - run: unzip -qq ngrok-stable-linux-amd64.zip
        shell: bash
      - run: ./ngrok authtoken ${{ secrets.NGROK_SECRET }}
        shell: bash
      - run: ./ngrok http 6006
        shell: bash
      - run : |
          echo $(curl -s localhost:6006/inspect/http | grep -oP 'window.common[^;]+' | sed 's/^[^\(]*("//' | sed 's/")\s*$//' | sed 's/\\"/"/g') | jq -r ".Session.Tunnels | values | map(.URL) | .[]" | grep "^http:"
        shell: bash 
  
  Tensorboard-Stop:
    runs-on: ubuntu-latest
    if: ${{ github.event.comment.body == '/done'}}
    steps:
      - name: Shutdown
        run: exit 1

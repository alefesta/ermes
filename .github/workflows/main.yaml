name: Ermes Main

on:
  issues:
    types: [opened]
env:
  BRANCH: ${{github.actor}}
  GITHUB_SERVER_URL: GITHUB_SERVER_URL
  GITHUB_REPOSITORY: GITHUB_REPOSITORY
  FILES: string
jobs:
  Set-Up-Ermes:
    runs-on: ubuntu-latest
    # container: docker.io/hello-world
    steps:
      # - name: Print Body
      #   env:
      #     BODY: ${{ github.event.issue.body }}
      #     TITLE: ${{ github.event.issue.title }}
      #   run: |
      #     echo $BODY > input.txt
      #     if grep -i "- [x] Tensorflow Data Validation" input.txt
      #     then
      #         echo "yahyyy"
      #     else
      #         echo "nooooo"
      #     fi
      #     echo $TITLE
      # - name: View the github context
      #   run: echo "$GITHUB_CONTEXT"
      #   env:
      #     GITHUB_CONTEXT: ${{ toJson(github) }}
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2

        with:
          python-version: '3.8'
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Prepare Images Artifacts
        run: |
          mkdir -p shared/.base.md
      # - run: OUT=$(python tfx_demo.py 2>&1) && echo $OUT > out.txt
      - id: get-comment-body
        run: |
          body="$(python demo.py)"
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          body="${body//$'\r'/'%0D'}" 
          echo "::set-output name=body::$body"
          git config user.name ${{github.actor}}
          git add .
          git commit -m "upload images"
          git push

      - name: Create comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: ${{ steps.get-comment-body.outputs.body }}
      - run: |       
          cd shared
          ls
      - run: |
          git fetch
          git checkout 
          git pull
      - id: echo_download
        run: |
          for ${{env.FILES}} in shared/*.png; do
            echo "::set-output name=body::${{env.GITHUB_SERVER_URL}}/${{env.GITHUB_REPOSITORY}}/blob/main/shared/${{env.FILES}}.png}"
          done
      - name: Create Second comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
              ![](${{ steps.echo_download.outputs.body }})
  #     - name: Commit files # transfer the new html files back into the repository
  #       uses: actions/checkout@v2
  #       with:
  #         token: ${{ secrets.GH_WORKFLOW }}
  #     - run: |
  #         git config user.name github-actions
  #         git config user.email github-actions@github.com
  #         git checkout -b ${{github.actor}}
  #         cd .github/workflows && curl -O https://raw.githubusercontent.com/alefesta/ermes/main/test.yaml && mv test.yaml action.yaml
  #         git add .
  #         git commit -m "generated"
  #         git push --set-upstream origin ${{github.actor}}
  #     - name: Init
  #       run: echo 'The triggering workflow passed at $BRANCH'
  #     - name: Sync
  #       uses: actions/checkout@v2
  #     - run: |
  #         git fetch
  #         git checkout $BRANCH
  #         git pull
  #     - name: Create Initial Comment
  #       uses: peter-evans/create-or-update-comment@v1
  #       with:
  #         issue-number: ${{ github.event.issue.number }}
  #         body: |
  #           ## Ermes Execution Steps

  #           - [X] Branch created  as: [${{ github.workspace}}](${{ github.actor}})
      
  #     - name: Wait For It
  #       run: |
  #         sleep 3
  #     - name: Find Comment
  #       uses: peter-evans/find-comment@v1
  #       id: fc
  #       with:
  #         issue-number: ${{ github.event.issue.number }}
  #         comment-author: 'github-actions[bot]'
  #         body-includes: Ermes Execution Steps
  #     - name: Update comment
  #       if: steps.fc.outputs.comment-id != ''
  #       uses: peter-evans/create-or-update-comment@v1
  #       with:
  #         comment-id: ${{ steps.fc.outputs.comment-id }}
  #         body: |
  #           - [X] Scripts Installed

  # Execute-Code:
  #     needs: Set-Up-Ermes
  #     uses: alefesta/executor/.github/workflows/executor.yaml@main
  # Comment-Created:
  #   needs: Execute-Code
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Find Comment
  #     uses: peter-evans/find-comment@v1
  #     id: fc
  #     with:
  #       issue-number: ${{ github.event.issue.number }}
  #       comment-author: 'github-actions[bot]'
  #       body-includes: Ermes Execution Steps

  #   - name: Create comment
  #     if: steps.fc.outputs.comment-id == ''
  #     uses: peter-evans/create-or-update-comment@v1
  #     with:
  #       issue-number: ${{ github.event.issue.number }}
  #       body: |
  #         This comment was written by a bot!
  #       reactions: rocket

  #   - name: Update comment
  #     if: steps.fc.outputs.comment-id != ''
  #     uses: peter-evans/create-or-update-comment@v1
  #     with:
  #       comment-id: ${{ steps.fc.outputs.comment-id }}
  #       body: |
  #           - [X] Code Executed
  #       reactions: hooray
